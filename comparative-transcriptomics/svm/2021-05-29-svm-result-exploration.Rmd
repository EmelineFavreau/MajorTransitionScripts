---
title: "SVM results exploration"
author: "Emeline Favreau"
date: "2021/05/29"
output: html_document
---

Copyright 2021 Emeline Favreau, University College London.


# Objective of analysis
We tested each species againt a dataset comprising gene expression data for the five other species

## Analysis steps:
- Obtaining data
- Aim 1: description
- Aim 2: description
- Aim 3: description
- Aim 4: description



```{r load all the libraries, eval = TRUE, echo = FALSE, include = FALSE}
# get libraries
basic_libraries <- c("ggplot2",
                     "tidyverse")

for (lib in basic_libraries) {
        if (require(package = lib, character.only = TRUE)) {
                print("Successful")
        } else {
                print("Installing")
                install.packages(lib)
                library(lib, character.only = TRUE )
        }
}
```


```{r import data, eval = TRUE, echo = FALSE, include = FALSE}
# phenotypic table: species , sample, R or NR
pheno <- read.csv("input/species-pheno-sampleName.txt",
                  sep="\t", stringsAsFactors=FALSE)


# prediction table contains for each step of recursive feature selection
# probability of being a reproductive for each sample
Ceratina_australensis_SVM_all_species_prediction_table <- read.csv("result/20-iterations/Ceratina_australensis_SVM_all_species_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Ceratina_calcarata_SVM_all_species_prediction_table <- read.csv("result/20-iterations/Ceratina_calcarata_SVM_all_species_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Megalopta_genalis_SVM_all_species_prediction_table <- read.csv("result/20-iterations/Megalopta_genalis_SVM_all_species_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Polistes_canadensis_SVM_all_species_prediction_table <- read.csv("result/20-iterations/Polistes_canadensis_SVM_all_species_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Liostenogaster_flavolineata_SVM_all_species_prediction_table <- read.csv("result/20-iterations/Liostenogaster_flavolineata_SVM_all_species_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Polistes_dominula_SVM_all_species_prediction_table <- read.csv("result/20-iterations/Polistes_dominula_SVM_all_species_prediction_table",
                                    sep="", stringsAsFactors=FALSE)




# trained on bees only
Ceratina_australensis_SVM_on_bees_prediction_table <- read.csv("result/20-iterations-beeonly/Ceratina_australensis_SVM_bees_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Ceratina_calcarata_SVM_on_bees_prediction_table <- read.csv("result/20-iterations-beeonly/Ceratina_calcarata_SVM_bees_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Megalopta_genalis_SVM_on_bees_prediction_table <- read.csv("result/20-iterations-beeonly/Megalopta_genalis_SVM_bees_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Polistes_dominula_SVM_on_bees_prediction_table <- read.csv("result/20-iterations-beeonly/Polistes_dominula_SVM_bees_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Polistes_canadensis_SVM_on_bees_prediction_table <- read.csv("result/20-iterations-beeonly/Polistes_canadensis_SVM_bees_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Liostenogaster_flavolineata_SVM_on_bees_prediction_table <- read.csv("result/20-iterations-beeonly/Liostenogaster_flavolineata_SVM_bees_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

# trained on wasps
Ceratina_australensis_SVM_on_wasps_prediction_table <- read.csv("result/20-iterations-wasponly/Ceratina_australensis_SVM_wasps_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Ceratina_calcarata_SVM_on_wasps_prediction_table <- read.csv("result/20-iterations-wasponly/Ceratina_calcarata_SVM_wasps_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Megalopta_genalis_SVM_on_wasps_prediction_table <- read.csv("result/20-iterations-wasponly/Megalopta_genalis_SVM_wasps_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Polistes_dominula_SVM_on_wasps_prediction_table <- read.csv("result/20-iterations-wasponly/Polistes_dominula_SVM_wasps_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Polistes_canadensis_SVM_on_wasps_prediction_table <- read.csv("result/20-iterations-wasponly/Polistes_canadensis_SVM_wasps_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)

Liostenogaster_flavolineata_SVM_on_wasps_prediction_table <- read.csv("result/20-iterations-wasponly/Liostenogaster_flavolineata_SVM_wasps_only_prediction_table",
                                    sep="", stringsAsFactors=FALSE)
```

## Aim 1: Ceratina australensis trained on 5 species

```{r aim 1, eval = TRUE, echo = FALSE, include = TRUE}
# perform analysis
  
# make a long format dataframe
Caus_long <- tidyr::gather(Ceratina_australensis_SVM_all_species_prediction_table[complete.cases(Ceratina_australensis_SVM_all_species_prediction_table),],
                    sample, queen_prob, SRR2917198:SRR2915407, factor_key=FALSE)

# add phenotype column
Caus_long$phenotype <- pheno$Phenotype[match(Caus_long$sample, pheno$SampleName)]

# change any outlier
Caus_long$queen_prob[Caus_long$queen_prob < 0] <- 0
Caus_long$queen_prob[Caus_long$queen_prob > 1] <- 1

# from the output model: number of predictor genes
Caus_predictor_num <- 684

# make a df with means per phenotype
average_pheno <-  Caus_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Caus_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
  scale_color_manual(values=c("#6baed6", "#08519c")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Caus_predictor_num,  col = 'black') +
  # geom_text(aes(Caus_predictor_num, 0.02,
  #               label = Caus_predictor_num, hjust = 1.5)) +
  ylim(0,1) +
  ggtitle("Ceratina australensis") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()

# save the plot as a tiff file
ggsave("result/20-iterations/Ceratina_australensis_trained_on_5_species.tiff",
       device = "tiff")

```

Interestingly, one sample's predicted phenotype does not match the expected phenotype.

## Aim 2: Ceratina calcarata trained on 5 species

```{r aim 2, eval = TRUE, echo = FALSE, include = TRUE}
# perform analysis
# make a long format dataframe
Ccal_long <- tidyr::gather(Ceratina_calcarata_SVM_all_species_prediction_table[complete.cases(Ceratina_calcarata_SVM_all_species_prediction_table),],
                    sample, queen_prob, SRR13281988:SRR13282006, factor_key=FALSE)

# add phenotype column
Ccal_long$phenotype <- pheno$Phenotype[match(Ccal_long$sample, pheno$SampleName)]

# change any outlier
Ccal_long$queen_prob[Ccal_long$queen_prob < 0] <- 0
Ccal_long$queen_prob[Ccal_long$queen_prob > 1] <- 1
# from the output model: number of predictor genes
Ccal_predictor_num <- 683

# make a df with means per phenotype
average_pheno <-  Ccal_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Ccal_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
   scale_color_manual(values=c("#6baed6", "#08519c")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Ccal_predictor_num,  col = 'black') +
  # geom_text(aes(Ccal_predictor_num, 0.02,
  #               label = Ccal_predictor_num, hjust = 1.5)) +
  ylim(0,1) +
  ggtitle("Ceratina calcarata") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()

# save the plot as a tiff file
ggsave("result/20-iterations/Ceratina_calcarata_trained_on_5_species.tiff",
       device = "tiff")

```

## Aim 3: Megalopta genalis trained on 5 species

```{r aim 3, eval = TRUE, echo = FALSE, include = TRUE}
# perform analysis
# make a long format dataframe
Mgen_long <- tidyr::gather(Megalopta_genalis_SVM_all_species_prediction_table[complete.cases(Megalopta_genalis_SVM_all_species_prediction_table),],
                    sample, queen_prob, SRR3948522:SRR3948569, factor_key=FALSE)

# add phenotype column
Mgen_long$phenotype <- pheno$Phenotype[match(Mgen_long$sample, pheno$SampleName)]

# change any outlier
Mgen_long$queen_prob[Mgen_long$queen_prob < 0] <- 0
Mgen_long$queen_prob[Mgen_long$queen_prob > 1] <- 1
# from the output model: number of predictor genes
Mgen_predictor_num <- 506

# make a df with means per phenotype
average_pheno <-  Mgen_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Mgen_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
  scale_color_manual(values=c("#6baed6", "#08519c")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Mgen_predictor_num,  col = 'black') +
  # geom_text(aes(Mgen_predictor_num, 0.02,
  #               label = Mgen_predictor_num, hjust = 1.5)) +
  ylim(0,1) +
  ggtitle("Megalopta genalis") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()

# save the plot as a tiff file
ggsave("result/20-iterations/Megalopta_genalis_trained_on_5_species.tiff",
       device = "tiff")
```
Conclusion

## Aim 4: Liostenogaster flavolineata trained on 5 species

```{r aim 4, eval = TRUE, echo = FALSE, include = TRUE}
# choose colours orange: light for NR #fec44f , dark for R #cc4c02
# make a long format dataframe
Lfla_long <- tidyr::gather(Liostenogaster_flavolineata_SVM_all_species_prediction_table[complete.cases(Liostenogaster_flavolineata_SVM_all_species_prediction_table),],
                    sample, queen_prob, SocF10:SocR8, factor_key=FALSE)

# add phenotype column
Lfla_long$phenotype <- pheno$Phenotype[match(Lfla_long$sample, pheno$SampleName)]

# change any outlier
Lfla_long$queen_prob[Lfla_long$queen_prob < 0] <- 0
Lfla_long$queen_prob[Lfla_long$queen_prob > 1] <- 1
# from the output model: number of predictor genes
Lfla_predictor_num <- 407

# make a df with means per phenotype
average_pheno <-  Lfla_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Lfla_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
  scale_color_manual(values=c("#fec44f", "#cc4c02")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Lfla_predictor_num,  col = 'black') +
  # geom_text(aes(Lfla_predictor_num, 0.02,
  #               label = Lfla_predictor_num, hjust = 1.5)) +
  ylim(0,1) +
  ggtitle("Liostenogaster flavolineata") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()

# save the plot as a tiff file
ggsave("result/20-iterations/Liostenogaster_flavolineata_trained_on_5_species.tiff",
       device = "tiff")
```
Conclusion

## Aim 5: Polistes canadensis trained on 5 species

```{r aim 5, eval = TRUE, echo = FALSE, include = TRUE}
# perform analysis
# make a long format dataframe
Pcan_long <- tidyr::gather(Polistes_canadensis_SVM_all_species_prediction_table[complete.cases(Polistes_canadensis_SVM_all_species_prediction_table),],
                    sample, queen_prob, SRR1519108:SRR1519117, factor_key=FALSE)

# add phenotype column
Pcan_long$phenotype <- pheno$Phenotype[match(Pcan_long$sample, pheno$SampleName)]

# change any outlier
Pcan_long$queen_prob[Pcan_long$queen_prob < 0] <- 0
Pcan_long$queen_prob[Pcan_long$queen_prob > 1] <- 1
# from the output model: number of predictor genes
Pcan_predictor_num <- 554

# make a df with means per phenotype
average_pheno <-  Pcan_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Pcan_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
  scale_color_manual(values=c("#fec44f", "#cc4c02")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Pcan_predictor_num,  col = 'black') +
  # geom_text(aes(Pcan_predictor_num, 0.02,
  #               label = Pcan_predictor_num, hjust = 1.5)) +
  ylim(0,1) +
  ggtitle("Polistes canadensis") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()

# save the plot as a tiff file
ggsave("result/20-iterations/Polistes_canadensis_trained_on_5_species.tiff",
       device = "tiff")
```

## Aim 6: Polistes dominula trained on 5 species

```{r aim 6, eval = TRUE, echo = FALSE, include = TRUE}
# perform analysis
# make a long format dataframe
Pdom_long <- tidyr::gather(Polistes_dominula_SVM_all_species_prediction_table[complete.cases(Polistes_dominula_SVM_all_species_prediction_table),],
                    sample, queen_prob, F03BL:W70RDYL, factor_key=FALSE)

# add phenotype column
Pdom_long$phenotype <- pheno$Phenotype[match(Pdom_long$sample, pheno$SampleName)]

# change any outlier
Pdom_long$queen_prob[Pdom_long$queen_prob < 0] <- 0
Pdom_long$queen_prob[Pdom_long$queen_prob > 1] <- 1
# from the output model: number of predictor genes
Pdom_predictor_num <- 554

# make a df with means per phenotype
average_pheno <-  Pdom_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Pdom_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
  scale_color_manual(values=c("#fec44f", "#cc4c02")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Pdom_predictor_num,  col = 'black') +
  # geom_text(aes(Pdom_predictor_num, 0.02,
  #               label = Pdom_predictor_num, hjust = 1.5)) +
  ylim(0,1) +
  ggtitle("Polistes dominula") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()

# save the plot as a tiff file
ggsave("result/20-iterations/Polistes_dominula_trained_on_5_species.tiff",
       device = "tiff")
```
Conclusion

## Aim 7: Ceratina australensis trained on bees

```{r aim 7, eval = TRUE, echo = FALSE, include = TRUE}
# perform analysis
# make a long format dataframe
Caus_long <- tidyr::gather(Ceratina_australensis_SVM_on_bees_prediction_table[complete.cases(Ceratina_australensis_SVM_on_bees_prediction_table),],
                    sample, queen_prob, SRR2917198:SRR2915407, factor_key=FALSE)

# add phenotype column
Caus_long$phenotype <- pheno$Phenotype[match(Caus_long$sample, pheno$SampleName)]

# change any outlier
Caus_long$queen_prob[Caus_long$queen_prob < 0] <- 0
Caus_long$queen_prob[Caus_long$queen_prob > 1] <- 1

# from the output model: number of predictor genes
Caus_predictor_num <- 478

# make a df with means per phenotype
average_pheno <-  Caus_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Caus_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
  scale_color_manual(values=c("#6baed6", "#08519c")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Caus_predictor_num,  col = 'black') +
  ylim(0,1) +
  ggtitle("Ceratina australensis trained on bees only") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()

# save the plot as a tiff file
ggsave("result/20-iterations-beeonly/Ceratina_australensis_trained_on_bees.tiff",
       device = "tiff")

```

## Aim 8: Ceratina calcarata trained on bees

```{r aim 8, eval = TRUE, echo = FALSE, include = TRUE}
# perform analysis
# make a long format dataframe
Ccal_long <- tidyr::gather(Ceratina_calcarata_SVM_on_bees_prediction_table[complete.cases(Ceratina_calcarata_SVM_on_bees_prediction_table),],
                    sample, queen_prob, SRR2917198:SRR2915407, factor_key=FALSE)

# add phenotype column
Ccal_long$phenotype <- pheno$Phenotype[match(Ccal_long$sample, pheno$SampleName)]

# change any outlier
Ccal_long$queen_prob[Ccal_long$queen_prob < 0] <- 0
Ccal_long$queen_prob[Ccal_long$queen_prob > 1] <- 1

# from the output model: number of predictor genes
Ccal_predictor_num <- 478

# make a df with means per phenotype
average_pheno <-  Ccal_long %>% 
        group_by(phenotype, nfeatures) %>% 
        summarise(queen_prob = mean(queen_prob))
# plot
ggplot(data = Ccal_long, 
       aes(x = nfeatures, y = queen_prob, colour = phenotype)) +
  geom_line(aes(group = sample), alpha = .3) + 
  geom_line(data = average_pheno, alpha = .8, size = 3) +
  scale_color_manual(values=c("#6baed6", "#08519c")) +
  scale_x_reverse(limits = c(3718,100)) +
  geom_vline(xintercept = Ccal_predictor_num,  col = 'black') +
  ylim(0,1) +
  ggtitle("Ceratina calcarata trained on bees only") +
  ylab("Predicted Reproductive Probability") +
  xlab("Number of genes in model") +
  theme_bw()


```{r record versions of session, eval = TRUE, echo = FALSE, include = FALSE}
# record versions of R and packages here
sessionInfo()
# R version 3.6.3 (2020-02-29)
# Platform: x86_64-apple-darwin15.6.0 (64-bit)
# Running under: macOS Catalina 10.15.4
# 
# Matrix products: default
# BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib
# LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
# 
# locale:
# [1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8
# 
# attached base packages:
# [1] stats     graphics  grDevices utils     datasets  methods   base     
# 
# other attached packages:
# [1] forcats_0.5.0   stringr_1.4.0   dplyr_0.8.5     purrr_0.3.4     readr_1.3.1    
# [6] tidyr_1.0.3     tibble_3.0.1    tidyverse_1.3.0 ggplot2_3.3.0  
# loaded via a namespace (and not attached):
#  [1] Rcpp_1.0.4.6     cellranger_1.1.0 pillar_1.4.4     compiler_3.6.3   dbplyr_1.4.3    
#  [6] tools_3.6.3      lubridate_1.7.8  jsonlite_1.6.1   lifecycle_0.2.0  gtable_0.3.0    
# [11] nlme_3.1-147     lattice_0.20-41  pkgconfig_2.0.3  rlang_0.4.6      reprex_0.3.0    
# [16] cli_2.0.2        DBI_1.1.0        rstudioapi_0.11  yaml_2.2.1       haven_2.2.0     
# [21] xfun_0.13        xml2_1.3.2       withr_2.2.0      httr_1.4.1       knitr_1.28      
# [26] fs_1.4.1         generics_0.0.2   vctrs_0.3.0      hms_0.5.3        grid_3.6.3      
# [31] tidyselect_1.1.0 glue_1.4.1       R6_2.4.1         fansi_0.4.1      readxl_1.3.1    
# [36] modelr_0.1.7     magrittr_1.5     scales_1.1.1     backports_1.1.7  ellipsis_0.3.0  
# [41] rvest_0.3.5      assertthat_0.2.1 colorspace_1.4-1 stringi_1.4.6    munsell_0.5.0   
# [46] broom_0.5.6      crayon_1.3.4 
```
