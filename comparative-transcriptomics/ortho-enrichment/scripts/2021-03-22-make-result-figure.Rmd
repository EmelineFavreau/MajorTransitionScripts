---
title: "TopGo analysis"
author: "Emeline Favreau"
date: "22/03/2021"
output: html_document
---
Copyright 2021 Emeline Favreau, University College London.


###### Objective of analysis: Among the 3 wasp and 3 bee species, are there common pattern of GO term enrichment?

We obtained GO terms that are significantly enriched in our dataset subsets. Specifically, we focused on genes that are differentially expressed between reproductives and non-reproductives in _Ceratina australensis_, _C. calcarata_, _Megalopta genalis_, _Polistes canadensis_, _P. dominula_ and _Liostenogaster flavolineata_.


###### Analysis steps:
- Obtaining data
- Aim 1: Biological processes enrichment in all DEG
- Aim 2: Molecular function enrichment in all DEG
- Aim 3: Cellular component enrichment in all DEG
- Aim 4: Biological processes, upregulated in reproductives



```{r load all the libraries, eval = TRUE, echo = FALSE, include = FALSE}
# get libraries
basic_libraries <- c("ggplot2",
                     "tidyverse",
                     "readr")

for (lib in basic_libraries) {
        if (require(package = lib, character.only = TRUE)) {
                print("Successful")
        } else {
                print("Installing")
                install.packages(lib)
                library(lib, character.only = TRUE )
        }
}
```

```{r common groups}


# the groups that we are testing
all_species <- c("Polistes_canadensis",
          "Polistes_dominula",
          "Liostenogaster_flavolineata",
          "Ceratina_australensis",
          "Ceratina_calcarata" ,
          "Megalopta_genalis")

wasp <- c("Polistes_canadensis",
          "Polistes_dominula",
          "Liostenogaster_flavolineata")

bee <- c("Ceratina_australensis",
          "Ceratina_calcarata" ,
          "Megalopta_genalis")

```

##### Aim 1: Biological processes enrichment in all significant DEG

Amy Toth found more evidence of common patterns when the datasets are not subset by castes.
Here we search for common patterns across and within lineages for all significant differentially expressed genes, regardless of their directionality (e.g. if they are upregulated in reproductives or non-reproductives).

```{r import data BP all sig DEG, eval = TRUE, echo = FALSE, include = FALSE}
# GO terms enrichment result tables
# file obtained by TopGO, containing data description
# GO.ID	Term	Annotated	Significant	Expected	pvalue	species	dataSubset	goCategory
# these are Biological processes for DEG upregulated in Reproductives
Ceratina_australensis_BP <- read_delim("resultOnScratch/topgo_result_Ceratina_australensis_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Ceratina_calcarata_BP <- read_delim("resultOnScratch/topgo_result_Ceratina_calcarata_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Megalopta_genalis_BP <- read_delim("resultOnScratch/topgo_result_Megalopta_genalis_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_dominula_BP <- read_delim("resultOnScratch/topgo_result_Polistes_dominula_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_canadensis_BP <- read_delim("resultOnScratch/topgo_result_Polistes_canadensis_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Liostenogaster_flavolineata_BP <- read_delim("resultOnScratch/topgo_result_Liostenogaster_flavolineata_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

```

```{r make table BP , eval = TRUE, echo = FALSE, include = TRUE}
# subset for the important data 
australensis_table_BP <- Ceratina_australensis_BP %>% 
  filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

dominula_table_BP <- Polistes_dominula_BP %>%
  filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

genalis_table_BP <- Megalopta_genalis_BP %>%
  filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

canadensis_table_BP <- Polistes_canadensis_BP %>%
  filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

calcarata_table_BP <- Ceratina_calcarata_BP %>%
  filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

flavolineata_table_BP <- Liostenogaster_flavolineata_BP %>%
  filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

# result table: number of significant GO Terms for each species
result_BP_df  <-  as.data.frame(rbind(c("Ceratina_australensis",
                                        nrow(australensis_table_BP)),
                                      c("Ceratina_calcarata",
                                        nrow(calcarata_table_BP)),
                                      c("Megalopta_genalis",
                                        nrow(genalis_table_BP)),
                                      c("Polistes_dominula",
                                        nrow(dominula_table_BP)),
                                      c("Polistes_canadensis",
                                        nrow(canadensis_table_BP)),
                                      c("Liostenogaster_flavolineata",
                                        nrow(flavolineata_table_BP))),
    stringsAsFactors = FALSE)

colnames(result_BP_df) <- c("species", "Sig_GO_Term_in_BP")

result_BP_df

# obtain vector of all GO
GO.ID_BP <- unique(c(australensis_table_BP$GO.ID,
                     dominula_table_BP$GO.ID,
                     genalis_table_BP$GO.ID,
                     canadensis_table_BP$GO.ID,
                     calcarata_table_BP$GO.ID,
                     flavolineata_table_BP$GO.ID))


# make a new table
# columns: GOID, Terms, species
stacked_result_BP <- rbind(australensis_table_BP,
                  dominula_table_BP,
                  genalis_table_BP,
                  canadensis_table_BP,
                  calcarata_table_BP,
                  flavolineata_table_BP)

# obtain frequencies of GO Terms for all aspecies
test <- stacked_result_BP

# dataframe
# GOID | Species 1 | Species 2 | Species 3 | 
wide_df <- as.data.frame(matrix(NA, nrow = length(unique(test$GO.ID)),
                                ncol = 7))
# name the columns
colnames(wide_df) <- c("GO.ID", all_species)

# make a vector with all GO terms
go_vec <- unique(test$GO.ID)

# assign thios go terms to the column
wide_df$GO.ID <- go_vec

# set all species column count to 0
wide_df$Polistes_canadensis         <- 0
wide_df$Polistes_dominula           <- 0
wide_df$Liostenogaster_flavolineata <- 0
wide_df$Ceratina_australensis       <- 0
wide_df$Ceratina_calcarata          <- 0
wide_df$Megalopta_genalis           <- 0

for(i in go_vec){
  
  # subset data for a given GO Term ID
  this_subset <- test %>% filter(GO.ID == i)
  
  # assign 1 if present in this species
  if("Ceratina_australensis" %in% this_subset$species){
    wide_df$Ceratina_australensis[wide_df$GO.ID == i] <- 1
  }
  
  if("Polistes_canadensis" %in% this_subset$species){
    wide_df$Polistes_canadensis[wide_df$GO.ID == i] <- 1
  }
  
  if("Polistes_dominula" %in% this_subset$species){
    wide_df$Polistes_dominula[wide_df$GO.ID == i] <- 1
  }
  
  if("Liostenogaster_flavolineata" %in% this_subset$species){
    wide_df$Liostenogaster_flavolineata[wide_df$GO.ID == i] <- 1
  }
  
  if("Ceratina_calcarata" %in% this_subset$species){
    wide_df$Ceratina_calcarata[wide_df$GO.ID == i] <- 1
  }
  
  if("Megalopta_genalis" %in% this_subset$species){
    wide_df$Megalopta_genalis[wide_df$GO.ID == i] <- 1
  }
}


# add a column with count of species that have that GO term  
wide_df$species_count <- wide_df %>%
  select(all_of(all_species)) %>%
  rowSums()

# add a column with Term
wide_df$GOTerm <- test$Term[match(wide_df$GO.ID, test$GO.ID)]

# add a column for BP
wide_df$GOCategory <- "BP"

# save for supplementary info
write.table(x         = wide_df,
            file      = "resultOnScratch/all_BP_GOTerms.csv",
            quote     = FALSE,
            row.names = FALSE,
            sep       = ",")
```


```{r exploration of BP results}
## exploration of BP results
# there are only 2 species that have common GO Terms
# str(wide_df$species_count)

# now which GO ID are shared between species?
# none between the polistes
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Polistes_dominula == 1)

# one between polistes dominula and LF GO:1903320
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Liostenogaster_flavolineata == 1) %>% 
  filter(Polistes_dominula == 1) 

# GO:0007599 and GO:0050817 are common to Polistes canadensis and LF
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Liostenogaster_flavolineata == 1) 

# one between the ceratinas GO:0042417 
wide_df %>% select(GO.ID, all_of(bee)) %>% 
  filter(Ceratina_australensis == 1) %>% 
  filter(Ceratina_calcarata == 1) 

# GO:0044331 and GO:0016339  GO:0008045  GO:0042133 GO:0051480 are common to Ceratina_australensis and Megalopta
wide_df %>% select(GO.ID, all_of(bee), GOTerm) %>% 
  filter(Megalopta_genalis == 1) %>% 
  filter(Ceratina_australensis == 1)  %>% select(GO.ID, GOTerm)

# GO:0051260 GO:0051259  GO:0007268 GO:0098916 GO:0098916 GO:0099536 GO:0099537
wide_df %>% select(GO.ID, all_of(bee), GOTerm) %>% 
  filter(Megalopta_genalis == 1) %>% 
  filter(Ceratina_calcarata == 1) %>% select(GO.ID, GOTerm)

# GO:0055114; GO:0006826; GO:0032366
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Ceratina_australensis == 1) %>% select(GO.ID, GOTerm)

# GO:0008362
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Polistes_dominula == 1) %>% 
  filter(Ceratina_australensis == 1) %>% select(GO.ID, GOTerm)

# GO:0017144; GO:0055001; GO:0055002; GO:0030239; GO:0051186; GO:0042692; GO:0051146; GO:0006071; GO:0006732; GO:1903578; GO:0006790; GO:0008052; GO:0046661; GO:0019362; GO:0046496
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Liostenogaster_flavolineata == 1) %>% 
  filter(Ceratina_australensis == 1) %>% select(GO.ID, GOTerm)

# zero
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Ceratina_calcarata == 1) %>% select(GO.ID, GOTerm)

# zero
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Polistes_dominula == 1) %>% 
  filter(Ceratina_calcarata == 1) %>% select(GO.ID, GOTerm)

# zero
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Liostenogaster_flavolineata == 1) %>% 
  filter(Ceratina_calcarata == 1) %>% select(GO.ID, GOTerm)

# zero
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Megalopta_genalis == 1) %>% select(GO.ID, GOTerm)

# zero
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Polistes_dominula == 1) %>% 
  filter(Megalopta_genalis == 1) %>% select(GO.ID, GOTerm)

# GO:0055085; GO:0006811
wide_df %>% 
  filter(species_count == 2) %>% 
  filter(Liostenogaster_flavolineata == 1) %>% 
  filter(Megalopta_genalis == 1) %>% select(GO.ID, GOTerm)

# list of GO ID that are important for 2 species
common_BP_GO_vec <- c("GO:0051260", "GO:0051259", "GO:0007268",
                      "GO:0098916", "GO:0098916", "GO:0099536",
                      "GO:0099537", "GO:0044331", "GO:0016339",
                      "GO:0008045", "GO:0042133", "GO:0051480",
                      "GO:0042417 ", "GO:0007599", "GO:0050817")


test <- wide_df %>% 
  filter(GO.ID %in% common_BP_GO_vec) 

# check description (expectation: sensory mechanisms)
# but we see mainly synaptic and cellular processes
common_BP_GOTerms_df <- stacked_result_BP %>% 
  filter(GO.ID %in% common_BP_GO_vec) 

# save this list
write.table(x         = common_BP_GOTerms_df,
            file      = "resultOnScratch/common_BP_GOTerms.csv",
            quote     = FALSE,
            row.names = FALSE,
            sep       = ",")


```


##### Aim 2: Molecular Functions enrichment in all significant DEG



```{r import data MF all sig DEG, eval = TRUE, echo = FALSE, include = FALSE}
# GO terms enrichment result tables
# file obtained by TopGO, containing data description
# GO.ID	Term	Annotated	Significant	Expected	pvalue	species	dataSubset	goCategory
# these are Biological processes for DEG upregulated in Reproductives
Ceratina_australensis_MF <- read_delim("resultOnScratch/topgo_result_Ceratina_australensis_MF",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Ceratina_calcarata_MF <- read_delim("resultOnScratch/topgo_result_Ceratina_calcarata_MF",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Megalopta_genalis_MF <- read_delim("resultOnScratch/topgo_result_Megalopta_genalis_MF",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_dominula_MF <- read_delim("resultOnScratch/topgo_result_Polistes_dominula_MF",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_canadensis_MF <- read_delim("resultOnScratch/topgo_result_Polistes_canadensis_MF",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Liostenogaster_flavolineata_MF <- read_delim("resultOnScratch/topgo_result_Liostenogaster_flavolineata_MF",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

```

```{r make table MF , eval = TRUE, echo = FALSE, include = TRUE}
# subset for the important data 
australensis_table_MF <- Ceratina_australensis_MF %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

dominula_table_MF <- Polistes_dominula_MF %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

genalis_table_MF <- Megalopta_genalis_MF %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

canadensis_table_MF <- Polistes_canadensis_MF %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

calcarata_table_MF <- Ceratina_calcarata_MF %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

flavolineata_table_MF <- Liostenogaster_flavolineata_MF %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

# result table: number of significant GO Terms for each species
result_MF_df  <-  as.data.frame(rbind(c("Ceratina_australensis",
                                        nrow(australensis_table_MF)),
                                      c("Ceratina_calcarata",
                                        nrow(calcarata_table_MF)),
                                      c("Megalopta_genalis",
                                        nrow(genalis_table_MF)),
                                      c("Polistes_dominula",
                                        nrow(dominula_table_MF)),
                                      c("Polistes_canadensis",
                                        nrow(canadensis_table_MF)),
                                      c("Liostenogaster_flavolineata",
                                        nrow(flavolineata_table_MF))),
    stringsAsFactors = FALSE)

colnames(result_MF_df) <- c("species", "Sig_GO_Term_in_MF")

result_MF_df

# obtain vector of all GO
GO.ID_MF <- unique(c(australensis_table_MF$GO.ID,
                     dominula_table_MF$GO.ID,
                     genalis_table_MF$GO.ID,
                     canadensis_table_MF$GO.ID,
                     calcarata_table_MF$GO.ID,
                     flavolineata_table_MF$GO.ID))


# make a new table
# columns: GOID, Terms, species
stacked_result_MF <- rbind(australensis_table_MF,
                  dominula_table_MF,
                  genalis_table_MF,
                  canadensis_table_MF,
                  calcarata_table_MF,
                  flavolineata_table_MF)

# obtain frequencies of GO Terms for all aspecies
test <- stacked_result_MF

# dataframe
# GOID | Species 1 | Species 2 | Species 3 | 
wide_df <- as.data.frame(matrix(NA, nrow = length(unique(test$GO.ID)),
                                ncol = 7))
# name the columns
colnames(wide_df) <- c("GO.ID", all_species)

# make a vector with all GO terms
go_vec <- unique(test$GO.ID)

# assign thios go terms to the column
wide_df$GO.ID <- go_vec

# set all species column count to 0
wide_df$Polistes_canadensis         <- 0
wide_df$Polistes_dominula           <- 0
wide_df$Liostenogaster_flavolineata <- 0
wide_df$Ceratina_australensis       <- 0
wide_df$Ceratina_calcarata          <- 0
wide_df$Megalopta_genalis           <- 0

for(i in go_vec){
  
  this_subset <- test %>% filter(GO.ID == i)
  
  if("Ceratina_australensis" %in% this_subset$species){
    wide_df$Ceratina_australensis[wide_df$GO.ID == i] <- 1
  }
  
  if("Polistes_canadensis" %in% this_subset$species){
    wide_df$Polistes_canadensis[wide_df$GO.ID == i] <- 1
  }
  
  if("Polistes_dominula" %in% this_subset$species){
    wide_df$Polistes_dominula[wide_df$GO.ID == i] <- 1
  }
  
  if("Liostenogaster_flavolineata" %in% this_subset$species){
    wide_df$Liostenogaster_flavolineata[wide_df$GO.ID == i] <- 1
  }
  
  if("Ceratina_calcarata" %in%this_subset$species){
    wide_df$Ceratina_calcarata[wide_df$GO.ID == i] <- 1
  }
  
  if("Megalopta_genalis" %in%this_subset$species){
    wide_df$Megalopta_genalis[wide_df$GO.ID == i] <- 1
  }
}


# add a column with count of species that have that GO term  
wide_df$species_count <- wide_df %>% select(all_of(all_species)) %>% rowSums()

# add a column with Term
wide_df$GOTerm <- test$Term[match(wide_df$GO.ID, test$GO.ID)]

# add a column for MF
wide_df$GOCategory <- "MF"

# save for supplementary info
write.table(x         = wide_df,
            file      = "resultOnScratch/all_MF_GOTerms.csv",
            quote     = FALSE,
            row.names = FALSE,
            sep       = ",")
```

There are less GO Terms enriched in the category Molecular Function than Biological Processes.


```{r exploration of MF results}
## exploration of MF results
# there are 4 cases with 3 species that have common GO Terms
# summary(wide_df$species_count)
# save these GO:0004497 GO:0016491 GO:0016614  GO:0016418 
wide_df %>% filter(species_count == 3)


# now which GO ID are shared between species?
# 1 between the polistes GO:0031177
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Polistes_dominula == 1)

# none between polistes dominula and LF
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Liostenogaster_flavolineata == 1) %>% 
  filter(Polistes_dominula == 1) 

# GO:0016491  GO:0016614 GO:0016418 are common to Polistes canadensis and LF
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Liostenogaster_flavolineata == 1) 

# one between the ceratinas GO:0004497
wide_df %>% select(GO.ID, all_of(bee)) %>% 
  filter(Ceratina_australensis == 1) %>% 
  filter(Ceratina_calcarata == 1) 

#  none are common to Ceratina_australensis and Megalopta
wide_df %>% select(GO.ID, all_of(bee)) %>% 
  filter(Megalopta_genalis == 1) %>% 
  filter(Ceratina_australensis == 1) 

# GO:0030594 GO:0022839 GO:0022836 GO:0005230 GO:0015267 GO:0022803
wide_df %>% select(GO.ID, all_of(bee)) %>% 
  filter(Megalopta_genalis == 1) %>% 
  filter(Ceratina_calcarata == 1) 




# list of 11 GO ID that are important for 2 or 3  species
common_MF_GO_vec <- unique(c("GO:0030594", "GO:0022839", "GO:0022836",
                      "GO:0005230", "GO:0015267", "GO:0022803",
                      "GO:0004497", "GO:0016491", "GO:0016614",
                      "GO:0016418", "GO:0031177", "GO:0004497", 
                      "GO:0016491", "GO:0016614", "GO:0016418"))


test <- wide_df %>% 
  filter(GO.ID %in% common_MF_GO_vec) 

# check description (expectation: sensory mechanisms)
# but we see mainly synaptic and cellular processes
common_MF_GOTerms_df <- stacked_result_MF %>% 
  filter(GO.ID %in% common_MF_GO_vec) 

# save this list
write.table(x    = common_MF_GOTerms_df,
            file = "resultOnScratch/common_MF_GOTerms.csv",
            quote = FALSE,
            row.names = FALSE,
            sep = ",")
```
11 GO Terms of Molecular Function are shared by 2 or 3 species (never 3 species from same lineage).



##### Aim 3: Cellular component enrichment in all significant DEG



```{r import data CC all sig DEG, eval = TRUE, echo = FALSE, include = FALSE}
# GO terms enrichment result tables
# file obtained by TopGO, containing data description
# GO.ID	Term	Annotated	Significant	Expected	pvalue	species	dataSubset	goCategory
# these are Biological processes for DEG upregulated in Reproductives
Ceratina_australensis_CC <- read_delim("resultOnScratch/topgo_result_Ceratina_australensis_CC",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Ceratina_calcarata_CC <- read_delim("resultOnScratch/topgo_result_Ceratina_calcarata_CC",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Megalopta_genalis_CC <- read_delim("resultOnScratch/topgo_result_Megalopta_genalis_CC",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_dominula_CC <- read_delim("resultOnScratch/topgo_result_Polistes_dominula_CC",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_canadensis_CC <- read_delim("resultOnScratch/topgo_result_Polistes_canadensis_CC",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Liostenogaster_flavolineata_CC <- read_delim("resultOnScratch/topgo_result_Liostenogaster_flavolineata_CC",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

```

```{r make table CC , eval = TRUE, echo = FALSE, include = TRUE}
# subset for the important data 
australensis_table_CC <- Ceratina_australensis_CC %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

dominula_table_CC <- Polistes_dominula_CC %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

genalis_table_CC <- Megalopta_genalis_CC %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

canadensis_table_CC <- Polistes_canadensis_CC %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

calcarata_table_CC <- Ceratina_calcarata_CC %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

flavolineata_table_CC <- Liostenogaster_flavolineata_CC %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

# result table: number of significant GO Terms for each species
result_CC_df  <-  as.data.frame(rbind(c("Ceratina_australensis",
                                        nrow(australensis_table_CC)),
                                      c("Ceratina_calcarata",
                                        nrow(calcarata_table_CC)),
                                      c("Megalopta_genalis",
                                        nrow(genalis_table_CC)),
                                      c("Polistes_dominula",
                                        nrow(dominula_table_CC)),
                                      c("Polistes_canadensis",
                                        nrow(canadensis_table_CC)),
                                      c("Liostenogaster_flavolineata",
                                        nrow(flavolineata_table_CC))),
    stringsAsFactors = FALSE)

colnames(result_CC_df) <- c("species", "Sig_GO_Term_in_CC")

result_CC_df

# obtain vector of all GO
GO.ID_CC <- unique(c(australensis_table_CC$GO.ID,
                     dominula_table_CC$GO.ID,
                     genalis_table_CC$GO.ID,
                     canadensis_table_CC$GO.ID,
                     calcarata_table_CC$GO.ID,
                     flavolineata_table_CC$GO.ID))


# make a new table
# columns: GOID, Terms, species
stacked_result_CC <- rbind(australensis_table_CC,
                  dominula_table_CC,
                  genalis_table_CC,
                  canadensis_table_CC,
                  calcarata_table_CC,
                  flavolineata_table_CC)

# obtain frequencies of GO Terms for all aspecies
test <- stacked_result_CC

# dataframe
# GOID | Species 1 | Species 2 | Species 3 | 
wide_df <- as.data.frame(matrix(NA, nrow = length(unique(test$GO.ID)),
                                ncol = 7))
# name the columns
colnames(wide_df) <- c("GO.ID", all_species)

# make a vector with all GO terms
go_vec <- unique(test$GO.ID)

# assign thios go terms to the column
wide_df$GO.ID <- go_vec

# set all species column count to 0
wide_df$Polistes_canadensis         <- 0
wide_df$Polistes_dominula           <- 0
wide_df$Liostenogaster_flavolineata <- 0
wide_df$Ceratina_australensis       <- 0
wide_df$Ceratina_calcarata          <- 0
wide_df$Megalopta_genalis           <- 0

for(i in go_vec){
  
  this_subset <- test %>% filter(GO.ID == i)
  
  if("Ceratina_australensis" %in% this_subset$species){
    wide_df$Ceratina_australensis[wide_df$GO.ID == i] <- 1
  }
  
  if("Polistes_canadensis" %in% this_subset$species){
    wide_df$Polistes_canadensis[wide_df$GO.ID == i] <- 1
  }
  
  if("Polistes_dominula" %in% this_subset$species){
    wide_df$Polistes_dominula[wide_df$GO.ID == i] <- 1
  }
  
  if("Liostenogaster_flavolineata" %in% this_subset$species){
    wide_df$Liostenogaster_flavolineata[wide_df$GO.ID == i] <- 1
  }
  
  if("Ceratina_calcarata" %in%this_subset$species){
    wide_df$Ceratina_calcarata[wide_df$GO.ID == i] <- 1
  }
  
  if("Megalopta_genalis" %in%this_subset$species){
    wide_df$Megalopta_genalis[wide_df$GO.ID == i] <- 1
  }
}


# add a column with count of species that have that GO term  
wide_df$species_count <- wide_df %>% select(all_of(all_species)) %>% rowSums()


# add a column with Term
wide_df$GOTerm <- test$Term[match(wide_df$GO.ID, test$GO.ID)]

# add a column for CC
wide_df$GOCategory <- "CC"

# save for supplementary info
write.table(x         = wide_df,
            file      = "resultOnScratch/all_CC_GOTerms.csv",
            quote     = FALSE,
            row.names = FALSE,
            sep       = ",")
```

There are less GO Terms enriched in the category Cellular Component than Biological Processes.


```{r exploration of CC results}
## exploration of CC results
# there are 2 cases with 3 species that have common GO Terms
# summary(wide_df$species_count)
# save these GO:0004497 GO:0016491 GO:0016614  GO:0016418 
wide_df %>% filter(species_count == 3) %>% select(GO.ID)


# now which GO ID are shared between species?
# none between the polistes 
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Polistes_dominula == 1) %>% select(GO.ID)

# none between polistes dominula and LF
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Liostenogaster_flavolineata == 1) %>% 
  filter(Polistes_dominula == 1) %>% select(GO.ID)

# none
wide_df %>% select(GO.ID, all_of(wasp)) %>% 
  filter(Polistes_canadensis == 1) %>% 
  filter(Liostenogaster_flavolineata == 1) %>% select(GO.ID)

# GO:0000786 GO:0045211
wide_df %>% select(GO.ID, all_of(bee)) %>% 
  filter(Ceratina_australensis == 1) %>% 
  filter(Ceratina_calcarata == 1) %>% select(GO.ID)

# GO:0005576
# GO:0044421
# GO:0031012
# GO:0044459
# GO:0031226
# GO:0005887
# GO:0005911
# GO:0030054
wide_df %>% select(GO.ID, all_of(bee)) %>% 
  filter(Megalopta_genalis == 1) %>% 
  filter(Ceratina_australensis == 1) %>% select(GO.ID)

# GO:0045202 GO:1902495 GO:0034702 GO:1990351
wide_df %>% select(GO.ID, all_of(bee)) %>% 
  filter(Megalopta_genalis == 1) %>% 
  filter(Ceratina_calcarata == 1) %>% select(GO.ID)




# list of 18 GO ID that are important for 2 or 3  species
common_CC_GO_vec <- unique(c("GO:0045202", "GO:1902495", "GO:0034702",
                             "GO:1990351", "GO:0031012", "GO:0044459",
                             "GO:0005576", "GO:0004497", "GO:0016491",
                             "GO:0016614",  "GO:0016418","GO:0044421",
                             "GO:0031226", "GO:0005887", "GO:0005911",
                             "GO:0030054", "GO:0000786", "GO:0045211"))


test <- wide_df %>% 
  filter(GO.ID %in% common_CC_GO_vec) 

# check description (expectation: sensory mechanisms)
# but we see mainly synaptic and cellular processes
common_CC_GOTerms_df <- stacked_result_CC %>% 
  filter(GO.ID %in% common_CC_GO_vec) 

# save this list
write.table(x    = common_CC_GOTerms_df,
            file = "resultOnScratch/common_CC_GOTerms.csv",
            quote = FALSE,
            row.names = FALSE,
            sep = ",")
```
18 GO Terms of Cellular Component  are shared by 2 or 3 species (never 3 species from same lineage).


#####  Aim 4: Biological processes, upregulated in reproductives

```{r import data BP R, eval = TRUE, echo = FALSE, include = FALSE}
# GO terms enrichment result tables
# file obtained by TopGO, containing data description
# GO.ID	Term	Annotated	Significant	Expected	pvalue	species	dataSubset	goCategory
# these are Biological processes for DEG upregulated in Reproductives
Ceratina_australensis_R_BP <- read_delim("resultOnScratch/topgo_result_Ceratina_australensis_R_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Ceratina_calcarata_R_BP <- read_delim("resultOnScratch/topgo_result_Ceratina_calcarata_R_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Megalopta_genalis_R_BP <- read_delim("resultOnScratch/topgo_result_Megalopta_genalis_R_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_dominula_R_BP <- read_delim("resultOnScratch/topgo_result_Polistes_dominula_R_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_canadensis_R_BP <- read_delim("resultOnScratch/topgo_result_Polistes_canadensis_R_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Liostenogaster_flavolineata_R_BP <- read_delim("resultOnScratch/topgo_result_Liostenogaster_flavolineata_R_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

```


For each species, we present the number of significant GO terms associated with differentially expressed genes that are upregulated in reproductives.

```{r table R_BP, eval = TRUE, echo = FALSE, include = TRUE}
# subset for the important data - here we make up data
australensis_table <- Ceratina_australensis_R_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

dominula_table <- Polistes_dominula_R_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

genalis_table <- Megalopta_genalis_R_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

canadensis_table <- Polistes_canadensis_R_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

calcarata_table <- Ceratina_calcarata_R_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

flavolineata_table <- Liostenogaster_flavolineata_R_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

# result table
result_R_BP_df  <-  as.data.frame(rbind(c("Ceratina_australensis", nrow(australensis_table)),
    c("Ceratina_calcarata", nrow(calcarata_table)),
    c("Megalopta_genalis", nrow(genalis_table)),
    c("Polistes_dominula", nrow(dominula_table)),
    c("Polistes_canadensis", nrow(canadensis_table)),
    c("Liostenogaster_flavolineata", nrow(flavolineata_table))), stringsAsFactors = FALSE)

colnames(result_R_BP_df) <- c("species", "Sig_GO_Term_in_R_BP")

result_R_BP_df



```

There is no significant GO Term for Biological Processes that are common to all six species. 
161 significant GO Terms are common to 2 species, in the vast majority of the case, the species are a wasp and a bee.

```{r common pattern R BP, eval = TRUE, echo = FALSE, include = FALSE}
# obtain vector of all GO
GO.ID <- unique(c(australensis_table$GO.ID,
                  dominula_table$GO.ID,
                  genalis_table$GO.ID,
                  canadensis_table$GO.ID,
                  calcarata_table$GO.ID,
                  flavolineata_table$GO.ID))

# https://ggplot2.tidyverse.org/reference/geom_bar.html

# make a new table
# columns: GOID, Terms, species
stacked_result <- rbind(australensis_table,
                  dominula_table,
                  genalis_table,
                  canadensis_table,
                  calcarata_table,
                  flavolineata_table)

# add a Freq column
stacked_result$Freq <- 0

# populate Frequency column
for(i in 1:nrow(stacked_result)){
 
  # subset for one go term
  this_go_df <- stacked_result %>% filter(GO.ID == GO.ID[i])

  # calculate frequency and add to the column
  stacked_result$Freq[stacked_result$GO.ID == GO.ID[i]] <- nrow(this_go_df)
}

# reorder dataset by decreasing Freq
stacked_result_reordered <- stacked_result[order(stacked_result$Freq,
                                                 decreasing = T), ]

# applying factor to Freq column, to order the x axis in the following plot
stacked_result_reordered$Freq <- factor(stacked_result_reordered$Freq,
                                       ordered = TRUE)

# 136 GO Terms are common in 2 species
# Which species?
#nrow(stacked_result_reordered[stacked_result_reordered$Freq == 2, ])
#head(stacked_result_reordered[stacked_result_reordered$Freq == 2, ])
#stacked_result_reordered[grep(pattern = "GO:0055114", x = stacked_result_reordered$GO.ID), ]
#stacked_result_reordered %>% filter(Freq == 2) %>% 

# # this bar plot is for all results (Frequency of 2 or more)
# ggplot(stacked_result_reordered,
#        aes(y = GO.ID)) +
#  geom_bar(aes(fill = species),
#           position = position_stack(reverse = TRUE)) +
#  theme(legend.position = "top") +
#   theme(axis.text = element_text(size = 4)) +
#   scale_x_discrete(name = "species count", limits = c("1","2")) +
#   scale_y_discrete(name = "BP GO terms upregulated reproductives") +
#   ggtitle("All species")




```



```{r hypothesis common to wasps, eval = TRUE, echo = FALSE, include = FALSE}
# name the species of wasps
wasp <- c("Polistes_canadensis",
          "Polistes_dominula",
          "Liostenogaster_flavolineata")

subset_summary_ouputing(wasp)


```

There is no significant GO Term for Biological Processes that are common to all three wasps.

```{r hypothesis common to bees, eval = TRUE, echo = FALSE, include = FALSE}

#stacked bar chart bee only
# name the species of bees
bee <- c("Ceratina_australensis",
          "Ceratina_calcarata" ,
          "Megalopta_genalis")

subset_summary_ouputing(bee)

```


There is one significant GO Term (Biological Processes: mitotic DNA integrity checkpoint) that is common to two bee species: _Megalopta genalis_ and _Ceratina calcarata_.



```{r hypothesis facultative social R BP, eval = TRUE, echo = FALSE, include = FALSE}
#stacked bar chart bee only
# name the facultative social species
facultative_social <- c("Ceratina_australensis",
          "Liostenogaster_flavolineata" ,
          "Megalopta_genalis")

subset_summary_ouputing(facultative_social)

```

There is no common GO Terms enriched for faculatively social species (_Ceratina australensis_, _Liostenogaster flavolineata_, _Megalopta genalis_).


```{r hypothesis group living R BP, eval = TRUE, echo = FALSE, include = FALSE}

# name the group living species
group_living <- c("Ceratina_calcarata",
          "Polistes_dominula" ,
          "Polistes_canadensis")



subset_summary_ouputing(group_living)
```

There is no common GO Terms enriched for group living species (_Ceratina calcarata_, both _Polistes_).

```{r hypothesis body size R BP, eval = TRUE, echo = FALSE, include = FALSE}

# name the group living species
body_size <- c("Ceratina_calcarata",
          "Megalopta_genalis")

subset_summary_ouputing(body_size)
group_vec <- body_size
 # subset the data for group
body_size_stacked_result <- stacked_result %>% filter(species %in% group_vec)
    
    # update go vec
body_size_GO.ID <- unique(body_size_stacked_result$GO.ID)
      
    # add a Freq column
body_size_stacked_result$Freq <- 0
    
# populate Frequency column
for(i in 1:nrow(body_size_stacked_result)){
 # subset for one go term
 this_go_df <- body_size_stacked_result %>% filter(GO.ID == body_size_GO.ID[i])
    
 # calculate frequency and add to the column
 body_size_stacked_result$Freq[body_size_stacked_result$GO.ID == body_size_GO.ID[i]] <- nrow(this_go_df)
}
    
# reorder dataset by decreasing Freq
body_size_stacked_result_reordered <- body_size_stacked_result[order(body_size_stacked_result$Freq,
                                                     decreasing = T), ]
    
nrow(body_size_stacked_result_reordered[body_size_stacked_result_reordered$Freq == 2, ])
```

There is one common GO Term enriched for species with body size different between reproductives and non-reproductives: mitotic DNA integrity checkpoint (_Ceratina calcarata_, _Megalopta genalis_). Making sure that the DNA has no breaking point throughout the cell life cycle (during body growth/cell replacement).



```{r import data BP NR, eval = TRUE, echo = FALSE, include = FALSE}
#####  Aim 2: Biological processes, upregulated in non-reproductives
# GO terms enrichment result tables
# file obtained by TopGO, containing data description
# GO.ID	Term	Annotated	Significant	Expected	pvalue	species	dataSubset	goCategory
# these are Biological processes for DEG upregulated in Reproductives
Ceratina_australensis_NR_BP <- read_delim("resultOnScratch/topgo_result_Ceratina_australensis_NR_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Ceratina_calcarata_NR_BP <- read_delim("resultOnScratch/topgo_result_Ceratina_calcarata_NR_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Megalopta_genalis_NR_BP <- read_delim("resultOnScratch/topgo_result_Megalopta_genalis_NR_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_dominula_NR_BP <- read_delim("resultOnScratch/topgo_result_Polistes_dominula_NR_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Polistes_canadensis_NR_BP <- read_delim("resultOnScratch/topgo_result_Polistes_canadensis_NR_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

Liostenogaster_flavolineata_NR_BP <- read_delim("resultOnScratch/topgo_result_Liostenogaster_flavolineata_NR_BP",
                                    "\t", escape_double = FALSE, trim_ws = TRUE)

```



```{r table NR_BP, eval = TRUE, echo = FALSE, include = FALSE}
# subset for the important data - here we make up data
australensis_NR_table <- Ceratina_australensis_NR_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

dominula_NR_table <- Polistes_dominula_NR_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

genalis_NR_table <- Megalopta_genalis_NR_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

canadensis_NR_table <- Polistes_canadensis_NR_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

calcarata_NR_table <- Ceratina_calcarata_NR_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

flavolineata_NR_table <- Liostenogaster_flavolineata_NR_BP %>% filter(pvalue < 0.05) %>%
  select(GO.ID, species, Term)

# result table
result_NR_BP_df  <-  as.data.frame(rbind(c("Ceratina_australensis", nrow(australensis_NR_table)),
    c("Ceratina_calcarata", nrow(calcarata_NR_table)),
    c("Megalopta_genalis", nrow(genalis_NR_table)),
    c("Polistes_dominula", nrow(dominula_NR_table)),
    c("Polistes_canadensis", nrow(canadensis_NR_table)),
    c("Liostenogaster_flavolineata", nrow(flavolineata_NR_table))), stringsAsFactors = FALSE)

colnames(result_NR_BP_df) <- c("species", "Sig_GO_Term_in_NR_BP")

result_NR_BP_df

```






**Conclusion**

I want to check upstream code to make sure the data are processed without bug. I was sort-of expecting some significant GO terms common to all species, but in this example (DEG upregulated in reproductives), we see none. Having said that, Polistes species carry very little DEG to start with, maybe my expectations were too high.

To do:
explore other subsets of data (upregulated in non-reproductives) and other GO categories (Molecular function, Cellular component).


```{r record versions of session, eval = TRUE, echo = FALSE, include = FALSE}
# record versions of R and packages here
sessionInfo()
# R version 3.6.3 (2020-02-29)
# Platform: x86_64-apple-darwin15.6.0 (64-bit)
# Running under: macOS Catalina 10.15.4
# 
# Matrix products: default
# BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib
# LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
# 
# locale:
# [1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8
# 
# attached base packages:
# [1] stats     graphics  grDevices utils     datasets  methods   base     
# 
# other attached packages:
# [1] forcats_0.5.0   stringr_1.4.0   dplyr_0.8.5     purrr_0.3.4     readr_1.3.1    
# [6] tidyr_1.0.3     tibble_3.0.1    tidyverse_1.3.0 ggplot2_3.3.0  
# loaded via a namespace (and not attached):
#  [1] Rcpp_1.0.4.6     cellranger_1.1.0 pillar_1.4.4     compiler_3.6.3   dbplyr_1.4.3    
#  [6] tools_3.6.3      lubridate_1.7.8  jsonlite_1.6.1   lifecycle_0.2.0  gtable_0.3.0    
# [11] nlme_3.1-147     lattice_0.20-41  pkgconfig_2.0.3  rlang_0.4.6      reprex_0.3.0    
# [16] cli_2.0.2        DBI_1.1.0        rstudioapi_0.11  yaml_2.2.1       haven_2.2.0     
# [21] xfun_0.13        xml2_1.3.2       withr_2.2.0      httr_1.4.1       knitr_1.28      
# [26] fs_1.4.1         generics_0.0.2   vctrs_0.3.0      hms_0.5.3        grid_3.6.3      
# [31] tidyselect_1.1.0 glue_1.4.1       R6_2.4.1         fansi_0.4.1      readxl_1.3.1    
# [36] modelr_0.1.7     magrittr_1.5     scales_1.1.1     backports_1.1.7  ellipsis_0.3.0  
# [41] rvest_0.3.5      assertthat_0.2.1 colorspace_1.4-1 stringi_1.4.6    munsell_0.5.0   
# [46] broom_0.5.6      crayon_1.3.4 
```
