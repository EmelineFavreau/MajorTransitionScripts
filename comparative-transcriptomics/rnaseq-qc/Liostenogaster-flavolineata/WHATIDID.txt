# 2020-10-23
## Author: Emeline Favreau
## Objective: Running QC steps for Liostenogaster flavolineata

## Analysis steps:
# Obtaining data
# Aim 1: Run Nextflow
# Aim 2: TBD
# Aim 3: TBD

###############################################################################
# Obtaining data

# set project structure
Genusspecies="Liostenogaster-flavolineata"
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/input
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/result
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/input inputOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/result resultOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp tmp

# set up myriad.config (in the directory where the experiment will run)
cp ../myriad.config .

# copy input files: RNAseq raw reads, genome fasta, gff

ssh ucfaeef@transfer02

cd projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Liostenogaster-flavolineata/inputOnScratch 

# social reproductives
cp /mnt/gpfs/live/ritd-ag-project-rd00qm-mbent70/Liostenogaster_flavolineata/experiment1/data/SocialReproductive*/raw/*.fq.gz .

# social foragers
cp /mnt/gpfs/live/ritd-ag-project-rd00qm-mbent70/Liostenogaster_flavolineata/experiment1/data/SocialForager*/raw/*.fq.gz .

# get the genome
cp /mnt/gpfs/live/ritd-ag-project-rd00qm-mbent70/Liostenogaster_flavolineata/genome/Liostenogaster_flavolineata.fna .

gzip Liostenogaster_flavolineata.fna

# get the gff
cp /mnt/gpfs/live/ritd-ag-project-rd00qm-mbent70/Liostenogaster_flavolineata/genome/Liostenogaster_flavolineata.gff3 .

gzip Liostenogaster_flavolineata.gff3

exit


cd ..

# Katie needs the GFF
mkdir input
cp inputOnScratch/Liostenogaster_flavolineata.gff3.gz input/.

###############################################################################
# Aim 1:  running all samples 
mkdir tmp/star-all-samples

mkdir -p /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/result/star-all-samples

cp myriad.config tmp/star-all-samples/.

cd tmp/star-all-samples

tmux new-session

module load blic-modules

module load nextflow/19.10.0.5170

nextflow run nf-core/rnaseq \
	-profile singularity \
	--reads '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/input/*{1,2}.fq.gz' \
	--fasta '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/input/Liostenogaster_flavolineata.fna.gz' \
	--gff '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/input/Liostenogaster_flavolineata.gff3.gz' \
	--unStranded \
	--skipBiotypeQC \
	--fc_group_features gene_id \
	-r 1.4.2 \
	-c /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/tmp/star-all-samples/myriad.config \
	-with-tower \
	-resume \
	--outdir /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/result/star-all-samples

# cheeky_booth


# check strandedness - infered unstranded
grep "SSP estimation (fwd/rev)" /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/result/star-all-samples/qualimap/*1Aligned.sortedByCoord.out/rnaseq_qc_results.txt

# overall mapping: 75.17% - 85.52%
grep "Uniquely mapped reads %" /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/result/star-all-samples/STAR/logs/*Log.final.out | cut -f 2 | sort -n

# featurecounts - looks good
cat /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Liostenogaster-flavolineata/result/star-all-samples/featureCounts/gene_count_summaries/*featureCounts.txt.summary

#######
# Copy important info to back-up home

Genusspecies="Liostenogaster-flavolineata"
dataset="Taylor"

mkdir -p result/${dataset}
mkdir -p result/${dataset}/qc-before-trim/
mkdir -p result/${dataset}/qc-after-trim/
mkdir -p result/${dataset}/mapping
mkdir -p result/${dataset}/sample-batch-effects-plots
mkdir -p result/${dataset}/FPKM

# list pipeline information
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/software_versions.csv result/${dataset}/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/pipeline_report.txt result/${dataset}/.

# list of fastqc before trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/fastqc/zips/* result/${dataset}/qc-before-trim/.

# list of fastqc after trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/trim_galore/FastQC/*zip result/${dataset}/qc-after-trim/.

# Check for quality of mapping to the genome
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/STAR/logs/*Log.final.out result/${dataset}/mapping/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/gene_count_summaries/* result/${dataset}/mapping/.

# check sample and batch effect:
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/sample_correlation/*pdf result/${dataset}/sample-batch-effects-plots/.

# location of raw read counts
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/merged_gene_counts.txt result/${dataset}/.

# location of StringTie's RPKM
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/stringtieFPKM/*gene_abund.txt result/${dataset}/FPKM/.

# Double-check all info are backed-up
tree ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/${Genusspecies}/result/${dataset}