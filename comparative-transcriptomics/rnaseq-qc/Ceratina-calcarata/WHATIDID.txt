# 2020-11-09
## Author: Emeline Favreau
## Objective: Running QC steps for Ceratina calcarata

## Analysis steps:
# Obtaining data
# Aim 1: Run Nextflow
# Aim 2: TBD
# Aim 3: TBD

###############################################################################
# Obtaining data

# set project structure
Genusspecies="Ceratina-calcarata"
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/input
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/result
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/input inputOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/result resultOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp tmp

mkdir -p result

# set up myriad.config (in the directory where the experiment will run)
cp ../myriad.config .

# the first time, run these:
./obtain-NCBI-Ceratina-calcarata.sh

# next time, run these:
ssh ucfaeef@transfer02

cd ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Ceratina-calcarata/inputOnScratch

cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Ceratina_calcarata/ShellRehan2019/genome/* .
cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Ceratina_calcarata/ShellRehan2019/gff/* .
cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Ceratina_calcarata/ShellRehan2019/rnaseq/* .

exit

cd ..

cd inputOnScratch

# raw files on NCBI. SRA from 2019 publication: 
https://doi.org/10.1098/rspb.2019.1815
# biosample PRJNA434715




#########################
# running all samples 

mkdir tmp/star-all-samples

mkdir /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/result/star-all-samples

cp myriad.config tmp/star-all-samples/.

cd tmp/star-all-samples

tmux new-session

module load blic-modules

module load nextflow/19.10.0.5170

nextflow run nf-core/rnaseq \
	--reads '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/input/SRR132*{1,2}.fastq.gz' \
	--fasta '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/input/GCF_001652005.1_ASM165200v1_genomic.fna.gz' \
	--gff '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/input/GCF_001652005.1_ASM165200v1_genomic.gff.gz' \
	--reverseStranded \
	--skipBiotypeQC \
	--fc_group_features gene_id \
	-r 1.4.2 \
	-c /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/tmp/star-all-samples/myriad.config \
	-with-tower \
	-resume \
	--outdir /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/result/star-all-samples

# forward: cheeky_golick and crazy_montalcini and gloomy_bell and drunk_boyd
# reverse: serene_linnaeus and naughty_ampere and mad_meitner and thirsty_borg and desperate_archimedes



# # check strandedness - infered reverse!
grep "SSP estimation (fwd/rev)" /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/result/star-all-samples/qualimap/*1Aligned.sortedByCoord.out/rnaseq_qc_results.txt

# overall mapping: 64.46% - 86.86%
grep "Uniquely mapped reads %" /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/result/star-all-samples/STAR/logs/*Log.final.out | cut -f 2 | sort -n

# featurecounts - looks good
cat /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-calcarata/result/star-all-samples/featureCounts/gene_count_summaries/*featureCounts.txt.summary

#######
# Copy important info to back-up home

Genusspecies="Ceratina-calcarata"
dataset="ShellRehan2019"

mkdir -p result/${dataset}
mkdir -p result/${dataset}/qc-before-trim/
mkdir -p result/${dataset}/qc-after-trim/
mkdir -p result/${dataset}/mapping
mkdir -p result/${dataset}/sample-batch-effects-plots
mkdir -p result/${dataset}/FPKM

# list pipeline information
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/software_versions.csv result/${dataset}/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/pipeline_report.txt result/${dataset}/.

# list of fastqc before trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/fastqc/zips/* result/${dataset}/qc-before-trim/.

# list of fastqc after trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/trim_galore/FastQC/*zip result/${dataset}/qc-after-trim/.

# Check for quality of mapping to the genome
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/STAR/logs/*Log.final.out result/${dataset}/mapping/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/gene_count_summaries/* result/${dataset}/mapping/.

# check sample and batch effect:
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/sample_correlation/*pdf result/${dataset}/sample-batch-effects-plots/.

# location of raw read counts
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/merged_gene_counts.txt result/${dataset}/.

# location of StringTie's RPKM
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/stringtieFPKM/*gene_abund.txt result/${dataset}/FPKM/.

# Double-check all info are backed-up
tree ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/${Genusspecies}/result/${dataset}

# calcarata 33 samples, starting at the 3rd column 99,554,401
cut -f 3-35 merged_gene_counts.txt | tail -n +2  | awk '{SUM+=$1+$2+$3+$4+$5+$6+$7+$8+$9+$10+$11+$12+$13+$14+$15+$16+$17+$18+$19+$20+$21+$22+$23+$24+$25+$26+$27+$28+$29+$30+$31+$32+$33+$34+$35}END{print SUM}'
