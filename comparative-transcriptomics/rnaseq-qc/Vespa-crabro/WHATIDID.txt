# 2020-10-04
## Author: Emeline Favreau
## Objective: Running QC steps for Vespa crabro

## Analysis steps:
# Obtaining data
# Aim 1: Run Nextflow on all but one worker sample
# Aim 2: TBD
# Aim 3: TBD

###############################################################################
# Obtaining data

# set project structure
mkdir -p ~/Scratch/comparative-transcriptomics/Vespa-crabro/input
mkdir -p ~/Scratch/comparative-transcriptomics/Vespa-crabro/result
mkdir -p ~/Scratch/comparative-transcriptomics/Vespa-crabro/tmp
ln -s ~/Scratch/comparative-transcriptomics/Vespa-crabro/input inputOnScratch
ln -s ~/Scratch/comparative-transcriptomics/Vespa-crabro/result resultOnScratch
ln -s ~/Scratch/comparative-transcriptomics/Vespa-crabro/tmp tmp

# set up myriad.config (in the directory where the experiment will run)
cp ../myriad.config .

# copy input files: RNAseq raw reads, genome fasta, gff
cd inputOnScratch

scp ssh.rd.ucl.ac.uk:/rd/live/ritd-ag-project-rd00pm-cdrwy41/Vespa_crabro/RNAseqData/*{1,2}.fq.gz .

scp –r ssh.rd.ucl.ac.uk:/rd/live/ritd-ag-project-rd00pm-cdrwy41/Vespa_crabro/genome/data/assembly1/V.crabro.RM.hymenoptera.fasta .

scp –r ssh.rd.ucl.ac.uk:/rd/live/ritd-ag-project-rd00pm-cdrwy41/Vespa_crabro/genome/data/assembly1/V.crabro.evm.consensus.annotation.v1a.gff3 .

cd ..

###############################################################################
# Aim 1: Run Nextflow on all but one worker sample

mkdir STAR-4W-5G-2Q

cp

cp ../myriad.config STAR-4W-5G-2Q/.

cd STAR-4W-5G-2Q

tmux new-session

module load blic-modules

module load nextflow/19.10.0.5170

nextflow run nf-core/rnaseq \
	--reads '/lustre/scratch/scratch/ucfaeef/nextflow-test/input/4W-5G-2Q/*{1,2}.fq.gz' \
	--fasta /lustre/scratch/scratch/ucfaeef/nextflow-test/input/V.crabro.RM.hymenoptera.fasta \
	--gff /lustre/scratch/scratch/ucfaeef/nextflow-test/input/V.crabro.evm.consensus.annotation.v1a.gff3 \
	--forwardStranded \
	--skipBiotypeQC \
	--fc_group_features gene_id \
	-r 1.4.2 \
	-c /lustre/scratch/scratch/ucfaeef/nextflow-test/tmp/STAR-4W-5G-2Q/myriad.config \
	-with-tower \
	-bg \
	-resume \
	--outdir /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q
# prickly_woese


####
# Copy important info to back-up home

# list pipeline information
cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/pipeline_info/software_versions.csv ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/.

cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/pipeline_info/pipeline_report.txt ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/.

# list of fastqc before trimming. Visual check looks good.
mkdir ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/qc-before-trim

cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/fastqc/zips/* ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/qc-before-trim/.

# list of fastqc after trimming. Visual check looks ok. I am surprised that the quality is not so great.
mkdir ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/qc-after-trim

cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/trim_galore/FastQC/*zip ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/qc-after-trim/.

# Check for quality of mapping to the genome - all above 74%
grep "Uniquely mapped reads %" /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/STAR/logs/*Log.final.out > ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/uniquely-mapped-reads-percentage.txt


# Check read distributions over gene features: most reads should be assigned (ie low unassigned)
# something to check in R
mkdir ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/mapping

cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/featureCounts/gene_count_summaries/* ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/mapping/.

# check sample and batch effect:
mkdir ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/sample-batch-effects-plots

cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/sample_correlation/*pdf ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/sample-batch-effects-plots/.

# location of raw read counts (795K)
cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/featureCounts/merged_gene_counts.txt ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/.

# location of StringTie's RPKM
mkdir ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/FPKM

cp /lustre/scratch/scratch/ucfaeef/nextflow-test/result/STAR-4W-5G-2Q/stringtieFPKM/*gene_abund.txt ~/projects/MajorTransitionScripts/comparative-transcriptomics/Vespa-crabro/result/FPKM/.


# Double-check all info are backed-up

# delete scratch space
rm -rf /lustre/scratch/scratch/ucfaeef/nextflow-test/