# 2021-01-28
## Author: Emeline Favreau
## Objective: Running QC steps for Megalopta genalis

## Analysis steps:
# Obtaining data
# Aim 1: Run Nextflow
# Aim 2: TBD
# Aim 3: TBD

###############################################################################
# Obtaining data from Jones 2017

# set project structure
Genusspecies="Megalopta-genalis"
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/input
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/result
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/input inputOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/result resultOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp tmp

# set up myriad.config (in the directory where the experiment will run)
cp ../myriad.config .

# copy input files: RNAseq raw reads, genome fasta, gff

# the first time, run these:
./obtain-NCBI-Megalopta-genalis.sh

# next time, run these:
ssh ucfaeef@transfer02

cd ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Megalopta-genalis/inputOnScratch

cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Megalopta-genalis/genome/* .
cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Megalopta-genalis/gff/* .
cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Megalopta-genalis/rnaseq/* .

exit

cd ..

###############################################################################
# running Nextflow all samples 

mkdir tmp/star-all-samples

mkdir /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Megalopta-genalis/result/star-all-samples

cp myriad.config tmp/star-all-samples/.

cd tmp/star-all-samples

tmux new-session

module load blic-modules

module load nextflow/19.10.0.5170

nextflow run nf-core/rnaseq \
	-profile singularity \
	--reads '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Megalopta-genalis/input/*{1,2}.fastq.gz' \
	--fasta '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Megalopta-genalis/input/GCF_011865705.1_USU_MGEN_1.2_genomic.fna.gz' \
	--gff '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Megalopta-genalis/input/GCF_011865705.1_USU_MGEN_1.2_genomic.gff.gz' \
	--forwardStranded \
	--skipBiotypeQC \
	--fc_group_features gene_id \
	-r 1.4.2 \
	-c /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Megalopta-genalis/tmp/star-all-samples/myriad.config \
	-with-tower \
	-resume \
	--outdir /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Megalopta-genalis/result/star-all-samples

# mad_venter and furious_brattain  https://tower.nf/watch/hNTbqOL2tGIQA




#######
# Copy important info to back-up home

Genusspecies="Megalopta-genalis"
dataset="Jones2017"

cd ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/${Genusspecies}

mkdir -p result/${dataset}
mkdir -p result/${dataset}/qc-before-trim/
mkdir -p result/${dataset}/qc-after-trim/
mkdir -p result/${dataset}/mapping
mkdir -p result/${dataset}/sample-batch-effects-plots
mkdir -p result/${dataset}/FPKM
mkdir -p result/${dataset}/qualimap-reports

# list pipeline information
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/software_versions.csv result/${dataset}/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/pipeline_report.txt result/${dataset}/.

# list of fastqc before trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/fastqc/zips/* result/${dataset}/qc-before-trim/.

# list of fastqc after trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/trim_galore/FastQC/*zip result/${dataset}/qc-after-trim/.

# Check for quality of mapping to the genome
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/STAR/logs/*Log.final.out result/${dataset}/mapping/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/gene_count_summaries/* result/${dataset}/mapping/.




# check sample and batch effect:
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/sample_correlation/*pdf result/${dataset}/sample-batch-effects-plots/.

# location of raw read counts
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/merged_gene_counts.txt result/${dataset}/.

# location of StringTie's RPKM
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/stringtieFPKM/*gene_abund.txt result/${dataset}/FPKM/.

# check one sample report, then make all pdf of qualimap reports.
# check if report of strandedness match nextflow command (important for featureCounts)
#/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/qualimap/*sortedByCoord.out/* result/${dataset}/qualimap-reports/.
cp -r /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/qualimap/SRR3948522_1Aligned.sortedByCoord.out/* result/${dataset}/qualimap-reports/.

# Double-check all info are backed-up
tree ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/${Genusspecies}/result/${dataset}

# The first time, copy raw input (compressed and cleaned) on RDS
# copy NCBI info on RDS name  /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/
ssh ucfaeef@transfer02

ls ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Megalopta-genalis/inputOnScratch

cd /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/

mkdir Megalopta-genalis
mkdir Megalopta-genalis/genome
mkdir Megalopta-genalis/gff
mkdir Megalopta-genalis/rnaseq


cp /lustre/home/ucfaeef/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Megalopta-genalis/inputOnScratch/*fastq.gz /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Megalopta-genalis/rnaseq/.

cp /lustre/home/ucfaeef/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Megalopta-genalis/inputOnScratch/*fna.gz /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Megalopta-genalis/genome/.

cp /lustre/home/ucfaeef/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Megalopta-genalis/inputOnScratch/*gff.gz /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Megalopta-genalis/gff/.

exit


# delete scratch space (10% of 1Tb)
# rm -rf /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/

###########################
# calculate number of reads at 3 Nextflow steps this will need to be changed
# Jones2017 dataset
# obtain sequences numbers from fastqc reports before trimming
./count-sequences-before-qc.sh

# obtain sequences numbers from fastqc reports after trimming
./count-sequences-after-qc.sh

# obtain final read counts from FeatureCount (this is input to DESeq2)
./count-merged-read-counts.sh

# obtain per sample too from FeatureCounts

cat result/Patalano/qc-after-trim/number-reads-in-samples  
cat result/Patalano/qc-before-trim/number-reads-in-samples
cat result/Patalano/number-merged-read-counts-in-samples



