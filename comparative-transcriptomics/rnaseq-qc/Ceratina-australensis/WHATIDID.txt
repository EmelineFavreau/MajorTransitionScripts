# 2020-11-17
## Author: Emeline Favreau
## Objective: Running QC steps for Ceratina australensis

## Analysis steps:
# Obtaining data
# Aim 1: Run Nextflow
# Aim 2: Run Nextflow on the paired eleven
# Aim 3: clean the sample with issues SRR2916699
# Aim 4: Run Nextflow on all twelve samples (one of them has been cleaned)

###############################################################################
# Obtaining data

# set project structure
Genusspecies="Ceratina-australensis"
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/input
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/result
mkdir -p ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/input inputOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/result resultOnScratch
ln -s ~/Scratch/comparative-transcriptomics/${Genusspecies}/tmp tmp

mkdir -p result

# set up myriad.config (in the directory where the experiment will run)
cp ../myriad.config .

# copy input files: RNAseq raw reads, genome fasta, gff

cd inputOnScratch

# first time use 
# ./obtain-NCBI-Ceratina-australensis.sh

# 2nd time or after
ssh ucfaeef@transfer02

cd ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Ceratina-australensis/inputOnScratch

cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Ceratina_autralensis/Ceratina_australensis_2019/gff/*gz .

cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Ceratina_autralensis/Ceratina_australensis_2019/genome/*gz .

cp /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Ceratina_autralensis/Ceratina_australensis_2019/rnaseq/*gz .


cd ..


###################################
# Aim 1: Run Nextflow on all samples 

mkdir -p tmp/star-all-samples

mkdir -p /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/result/star-all-samples

cp myriad.config tmp/star-all-samples/.

cd tmp/star-all-samples

tmux new-session

module load blic-modules

module load nextflow/19.10.0.5170

nextflow run nf-core/rnaseq \
	-profile singularity \
	--reads '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/input/*{1,2}.fastq.gz' \
	--fasta '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/input/australensis_DNA.noNUL.fasta.gz' \
	--gff '/lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/input/australensis.MAKER_run_v1.cfig_v5.MAKER_ONLY_FORMATTED.gff.filtered.gz' \
	--reverseStranded \
	--skipBiotypeQC \
	--fc_group_features gene_id \
	-r 1.4.2 \
	-c /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/tmp/star-all-samples/myriad.config \
	-with-tower \
	-resume \
	--outdir /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/result/star-all-samples

### forward: elated_keller and curious_archimedes and shrivelled_blackwell and amazing_mirzakhani
### reverse: soggy_kare and wise_yonath and intergalactic_pare


# # check strandedness - infered reverse, need to run it again
grep "SSP estimation (fwd/rev)" /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/result/star-all-samples/qualimap/*1Aligned.sortedByCoord.out/rnaseq_qc_results.txt

# overall mapping: 55.92% - 83.70%
grep "Uniquely mapped reads %" /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/result/star-all-samples/STAR/logs/*Log.final.out | cut -f 2 | sort -n

# featurecounts - looks good
cat /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/Ceratina-australensis/result/star-all-samples/featureCounts/gene_count_summaries/*featureCounts.txt.summary

#######
# Copy important info to back-up home

Genusspecies="Ceratina-australensis"
dataset="Rehan2018"

mkdir -p result/${dataset}
mkdir -p result/${dataset}/qc-before-trim/
mkdir -p result/${dataset}/qc-after-trim/
mkdir -p result/${dataset}/mapping
mkdir -p result/${dataset}/sample-batch-effects-plots
mkdir -p result/${dataset}/FPKM

# list pipeline information
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/software_versions.csv result/${dataset}/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/pipeline_info/pipeline_report.txt result/${dataset}/.

# list of fastqc before trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/fastqc/zips/* result/${dataset}/qc-before-trim/.

# list of fastqc after trimming 
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/trim_galore/FastQC/*zip result/${dataset}/qc-after-trim/.

# Check for quality of mapping to the genome
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/STAR/logs/*Log.final.out result/${dataset}/mapping/.

cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/gene_count_summaries/* result/${dataset}/mapping/.

# check sample and batch effect:
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/sample_correlation/*pdf result/${dataset}/sample-batch-effects-plots/.

# location of raw read counts
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/featureCounts/merged_gene_counts.txt result/${dataset}/.

# location of StringTie's RPKM
cp /lustre/scratch/scratch/ucfaeef/comparative-transcriptomics/${Genusspecies}/result/star-all-samples/stringtieFPKM/*gene_abund.txt result/${dataset}/FPKM/.

# Double-check all info are backed-up
tree ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/${Genusspecies}/result/${dataset}


#### DRAFT
##### Pre-analysis clean

# checking paired files: same length? 
for i in $(ls *.fastq.gz); do
	zcat ${i} | wc -l
done

# there is a problem with SRR2916699

# clean the sample with issues SRR2916699

# trim-galore highlighted the problem: not same amount of reads in forward and reverse

# I use fastq_pair
# https://github.com/linsalrob/fastq-pair
# It rewrites the files with the sequences in order, with matching files for the two files provided on the command line, and then any single reads that are not matched are place in two separate files, one for each original file.

# need decompressed files
cp inputOnScratch/SRR2916699_1.fastq.gz tmp/.
cp inputOnScratch/SRR2916699_2.fastq.gz tmp/.
gzip -d tmp/SRR2916699_1.fastq.gz
gzip -d tmp/SRR2916699_2.fastq.gz

# provide smallest file first SRR2916699_1.fastq
ls -lrth tmp/SRR2916699*

# The optimal table size is basically somewhere around the number of sequences in your fastq files. 
# 78443752 / 4 = 19610938
wc -l tmp/SRR2916699_1.fastq
wc -l tmp/SRR2916699_2.fastq

# the resulting files will be in inputOnScratch/uneven-pairs
fastq_pair -t 19610938 tmp/SRR2916699_1.fastq tmp/SRR2916699_2.fastq

# replace the pair in input for Nextflow
rm inputOnScratch/SRR2916699_*.fastq.gz
cp tmp/SRR2916699_1.fastq inputOnScratch/SRR2916699_1.fastq
cp tmp/SRR2916699_2.fastq inputOnScratch/SRR2916699_2.fastq
gzip inputOnScratch/SRR2916699_*.fastq

# upload clean data to RDS
ssh ucfaeef@transfer02

cd ~/projects/MajorTransitionScripts/comparative-transcriptomics/rnaseq-qc/Ceratina-australensis/inputOnScratch

cp inputOnScratch/SRR2916699_*.fastq.gz /mnt/gpfs/live/rd01__/ritd-ag-project-rd011y-eefav92/Ceratina_autralensis/Ceratina_australensis_2019/rnaseq/.